<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitCoach Dashboard</title>
  <style>
    /* ============================================
       COLOR CONFIGURATION - CHANGE THESE VALUES
       ============================================ */
    :root {
      /* Background Gradient */
      --bg-gradient-start: #667eea;    /* Purple */
      --bg-gradient-end: #764ba2;      /* Dark Purple */
      
      /* Primary Button (Start/Stop/Settings) */
      --btn-primary-start: #667eea;    /* Purple */
      --btn-primary-end: #764ba2;      /* Dark Purple */
      
      /* Secondary Button (Randomize/Test) */
      --btn-secondary-start: #f093fb;  /* Pink */
      --btn-secondary-end: #f5576c;    /* Red-Pink */
      
      /* Metric Value Color (Pace, HR, Distance, Time) */
      --metric-color: #667eea;         /* Purple */
      
      /* Card Background */
      --card-bg: rgba(255,255,255,0.95); /* White with transparency */
      
      /* Text Colors */
      --text-primary: #333;            /* Dark gray */
      --text-muted: #888;              /* Medium gray */
      --text-white: #fff;              /* White */
    }
    
    /* ============================================
       GENERAL STYLES
       ============================================ */
    * { box-sizing: border-box; }
    body { 
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
      margin: 0; 
      padding: 20px;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-white);
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
    }
    h1 { margin: 0; color: var(--text-white); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    /* Main Metrics Card */
    .metrics-card { 
      padding: 32px; 
      border-radius: 16px; 
      background: var(--card-bg); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      margin-bottom: 20px;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 32px;
      text-align: center;
    }
    .metric-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .metric-label { 
      font-size: 14px; 
      color: var(--text-muted); 
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .metric-value { 
      font-size: 3rem; 
      font-weight: 700; 
      color: var(--metric-color);
      line-height: 1;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .heart-icon {
      font-size: 2.5rem;
      animation: heartbeat 1.2s ease-in-out infinite;
    }
    .heart-zone-1 { color: #3b82f6; } /* Blue - 120 */
    .heart-zone-2 { color: #fbbf24; } /* Yellow - 140 */
    .heart-zone-3 { color: #f97316; } /* Orange - 160 */
    .heart-zone-4 { color: #dc2626; } /* Deep Red - 180+ */
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      10% { transform: scale(1.1); }
      20% { transform: scale(1); }
      30% { transform: scale(1.1); }
      40% { transform: scale(1); }
    }
    .metric-unit { 
      font-size: 13px; 
      color: var(--text-muted);
    }
    .metric-slider {
      width: 100%;
      margin-top: 8px;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: #e0e0e0;
      outline: none;
    }
    .metric-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--metric-color);
      cursor: pointer;
    }
    .metric-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--metric-color);
      cursor: pointer;
      border: none;
    }
    
    /* Control Buttons */
    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    button { 
      padding: 14px 28px; 
      border-radius: 10px; 
      border: none; 
      background: linear-gradient(135deg, var(--btn-primary-start) 0%, var(--btn-primary-end) 100%); 
      color: white; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    button:active { transform: translateY(0); }
    button.secondary { 
      background: linear-gradient(135deg, var(--btn-secondary-start) 0%, var(--btn-secondary-end) 100%); 
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }
    button.secondary:hover { box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4); }
    button.settings {
      padding: 10px 20px;
      font-size: 24px;
      background: rgba(255,255,255,0.2);
      box-shadow: none;
    }
    button.settings:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    
    /* Settings Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text-primary);
      box-shadow: 0 16px 64px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h2 {
      margin: 0;
      color: var(--text-primary);
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      box-shadow: none;
    }
    .close-btn:hover {
      color: var(--text-primary);
      transform: none;
    }
    .setting-group {
      margin-bottom: 20px;
    }
    .setting-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 14px;
    }
    .setting-group select,
    .setting-group input[type="text"],
    .setting-group input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .setting-group input[type="range"] {
      width: 100%;
    }
    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: var(--metric-color);
    }
    .range-value {
      text-align: center;
      font-weight: 600;
      color: var(--metric-color);
      margin-top: 4px;
    }
    
    /* Demo Mode Card */
    .demo-card {
      padding: 24px;
      border-radius: 12px;
      background: var(--card-bg);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      color: var(--text-primary);
      margin-bottom: 20px;
      position: relative;
    }
    .demo-card h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .demo-info {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .demo-controls {
      display: block;
      width: 100%;
    }
    .demo-controls input[type="range"] {
      display: block;
      width: 100%;
      margin-bottom: 12px;
    }
    .demo-controls button {
      width: auto;
      display: inline-block;
    }
    .demo-status {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 13px;
      display: none;
      position: relative;
      z-index: 1;
    }
    .demo-status.active {
      display: block;
    }
    .demo-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .demo-progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .demo-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--btn-primary-start), var(--btn-primary-end));
      width: 0%;
      transition: width 0.3s;
    }
    .demo-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, #e0e0e0 0%, #667eea 100%);
      outline: none;
      margin: 0;
      padding: 0;
      cursor: pointer;
    }
    .demo-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
      border: 2px solid white;
    }
    .demo-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    /* Demo Settings */
    .demo-card .setting-group {
      margin-bottom: 16px;
      position: relative;
      z-index: 10;
    }
    .demo-card .setting-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      font-size: 13px;
      user-select: none;
    }
    .demo-card .setting-group input,
    .demo-card .setting-group select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      font-size: 13px;
      background: white !important;
      color: var(--text-primary) !important;
      position: relative;
      z-index: 10;
      -webkit-user-select: text !important;
      user-select: text !important;
    }
    .demo-card .setting-group input[type="text"],
    .demo-card .setting-group input[type="number"] {
      cursor: text !important;
    }
    .demo-card .setting-group select {
      cursor: pointer !important;
    }
    .demo-card .setting-group input:focus,
    .demo-card .setting-group select:focus {
      outline: none;
      border-color: var(--metric-color);
      z-index: 20;
    }
    .demo-card .setting-group button {
      width: 100%;
      padding: 10px;
      cursor: pointer !important;
    }
    
    /* Event Log */
    .log-card {
      padding: 20px;
      border-radius: 12px;
      background: var(--card-bg);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      color: var(--text-primary);
    }
    .log-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--text-primary);
    }
    .log { 
      height: 150px; 
      overflow: auto; 
      background: #f8f9fa; 
      padding: 12px; 
      border-radius: 8px; 
      border: 2px solid #e0e0e0;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }
    .log div { 
      margin-bottom: 4px; 
      color: var(--text-muted);
    }
    
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .metric-value { font-size: 2.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>FitCoach</h1>
    </div>

    <!-- Demo Mode Panel -->
    <div class="demo-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0;">
          <span id="modeIcon">üé¨</span>
          <span id="modeTitle">Demo Mode</span>
        </h3>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="connectDeviceBtn" onclick="connectVitalDevice()" style="padding: 8px 16px; font-size: 13px; display: none;">
            üîó Connect Device
          </button>
          <button id="modeToggleBtn" onclick="toggleMode()" style="padding: 8px 16px; font-size: 13px;">
            üì° Switch to Live Mode
          </button>
        </div>
      </div>
      <div class="demo-info" id="modeInfo">
        Control your virtual 21K (half marathon) run. Adjust metrics to trigger different coaching prompts: milestones, motivation, HR warnings, and status updates.
      </div>
      
      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-label">Avg Pace</div>
          <div class="metric-value" id="paceDisplay">5:00</div>
          <div class="metric-unit" id="paceUnit">min/km</div>
          <input id="paceSlider" type="range" class="metric-slider" min="240" max="600" value="300" step="5" oninput="pace=Number(this.value); updateDisplays(); triggerPrompts()" title="Adjust pace">
        </div>
        <div class="metric-item">
          <div class="metric-label">Heart Rate</div>
          <div class="metric-value">
            <span id="hrDisplay">140</span>
            <span class="heart-icon" id="heartIcon">‚ù§Ô∏è</span>
          </div>
          <div class="metric-unit">bpm</div>
          <input id="hrSlider" type="range" class="metric-slider" min="60" max="200" value="140" step="1" oninput="hr=Number(this.value); updateDisplays(); triggerPrompts()" title="Adjust heart rate">
        </div>
        <div class="metric-item">
          <div class="metric-label">Distance</div>
          <div class="metric-value" id="distDisplay">0.00</div>
          <div class="metric-unit" id="distUnit">km</div>
          <input id="distSlider" type="range" class="metric-slider" min="0" max="21" value="0" step="0.1" oninput="dist=Number(this.value); updateDisplays(); triggerPrompts()" title="Adjust distance">
        </div>
        <div class="metric-item">
          <div class="metric-label">Time</div>
          <div class="metric-value" id="timeDisplay">0:00</div>
          <div class="metric-unit">min:sec</div>
          <input id="timeSlider" type="range" class="metric-slider" min="0" max="7200" value="0" step="1" oninput="time=Number(this.value); updateDisplays()" title="Adjust time">
        </div>
      </div>
      
      <div class="controls">
        <button id="startBtn" onclick="toggleRun()">‚ñ∂Ô∏è Start</button>
        <button id="startTestBtn" class="secondary" onclick="testVoice()">‚ñ∂Ô∏è Start Test Voice</button>
        <button class="secondary" onclick="resetDemo()">üîÑ Reset</button>
      </div>
      
      <!-- Terra Connection Status -->
      <div id="terraStatus" style="display: none; margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 13px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 20px;">‚úÖ</span>
          <strong>Connected: <span id="terraDeviceName">Unknown Device</span></strong>
        </div>
        <div style="color: var(--text-muted);">
          Receiving real-time data from your device
        </div>
        <button onclick="disconnectVital()" style="margin-top: 8px; padding: 6px 12px; font-size: 12px; background: #f44336;">
          Disconnect
        </button>
      </div>
      
      <div class="demo-status active" id="demoStatus">
        <div class="demo-progress">
          <span id="demoPhase">Ready</span>
          <span id="demoDistance">0.0 km</span>
        </div>
        <div class="demo-progress-bar">
          <div class="demo-progress-fill" id="demoProgressFill"></div>
        </div>
        <div style="font-size: 12px; color: var(--text-muted);">
          <span id="demoHR">140 bpm</span> ‚Ä¢ 
          <span id="demoPace">5:00 /km</span> ‚Ä¢ 
          <span id="demoTime">0:00</span>
        </div>
      </div>
      
      <!-- Settings Controls -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 16px 0; font-size: 15px; color: var(--text-primary);">‚öôÔ∏è Settings</h4>
        
        <div class="setting-group">
          <label>Your Name (Optional)</label>
          <input type="text" id="demoUserName" placeholder="Enter your name" oninput="updateUserName()">
        </div>

        <div class="setting-group">
          <label>Your Age (for HR zones)</label>
          <input type="number" id="demoUserAge" value="30" min="18" max="100" oninput="updateAge()">
        </div>

        <div class="setting-group">
          <label>Voice</label>
          <select id="demoVoiceSelect" onchange="onVoiceChange()"></select>
        </div>

        <div class="setting-group">
          <label>Distance Unit</label>
          <select id="demoUnitSelect" onchange="updateUnits()">
            <option value="km">Kilometers</option>
            <option value="miles">Miles</option>
          </select>
        </div>

        <div class="setting-group">
          <label>Target Pace</label>
          <input type="text" id="demoTargetPace" value="5:00" placeholder="5:00">
        </div>

        <div class="setting-group">
          <label>Target Heart Rate (bpm)</label>
          <input type="number" id="demoTargetHR" value="150" min="60" max="200">
        </div>

        <div class="setting-group">
          <label for="toneSelect">Coach Style</label>
          <select id="toneSelect">
            <option value="motivational">Motivational</option>
            <option value="calm">Calm</option>
          </select>
        </div>

        <div class="setting-group">
          <label>Auto Prompts</label>
          <input type="checkbox" id="autoPromptsToggle" onchange="toggleAuto()">
        </div>

        <div class="setting-group">
          <label>Manual Prompt</label>
          <input type="text" id="demoManualText" placeholder="Type a custom message" style="margin-bottom: 8px;">
          <div style="display: flex; gap: 8px;">
            <button onclick="speakManual()" style="flex: 1; padding: 10px;">Speak</button>
            <button onclick="pauseAudio()" style="flex: 1; padding: 10px;">Pause</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="log-card">
      <h3>Event Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <audio id="player" style="display:none"></audio>

  <script>
    // ============================================
    // STATE & CONFIGURATION
    // ============================================
    let isLiveMode = false; // false = demo mode, true = live mode
    let vitalConnected = false;
    let vitalUserId = null;
    let ws = null; // WebSocket connection
    
    let pace = 300; // seconds per km (5:00)
    let hr = 140;
    let dist = 0.0;
    let time = 0; // seconds
    let auto = false;
    let running = false;
    let voices = [];
    let unit = 'km'; // 'km' or 'miles'
    let runInterval = null;
    let userName = '';
    let lastKmMilestone = 0;
    let userAge = 30; // Default age
    let hrMax = 190; // Will be calculated from age
    let highHrStartTime = null; // Track when HR goes too high
    let isSpeaking = false; // Track if audio is currently playing
    let usedPrompts = {}; // Track which prompts have been used
    let lastHrWarningTime = { caution: 0, warning: 0, danger: 0 }; // Track last warning per zone

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    const secToMinSec = s => {
      const m = Math.floor(s/60);
      const sec = Math.round(s%60).toString().padStart(2,'0');
      return m + ':' + sec;
    }

    const parseMinSec = (str) => {
      const parts = String(str).split(':').map(p=>Number(p));
      if (parts.length===2) return parts[0]*60 + parts[1];
      return Number(str);
    }

    const kmToMiles = km => km * 0.621371;
    const milesToKm = miles => miles / 0.621371;

    function log(msg){
      const t = new Date().toLocaleTimeString();
      document.getElementById('log').innerHTML = `<div>[${t}] ${msg}</div>` + document.getElementById('log').innerHTML;
    }

    // ============================================
    // VOICE LOADING
    // ============================================
    async function loadVoices(){
      try{
        const r = await fetch('/voices');
        if (!r.ok) {
          log('Voices API error: ' + r.status);
          return;
        }
        const data = await r.json();
        voices = Array.isArray(data) ? data : (data.voices || []);
        
        // Curated selection: Custom voice from ElevenLabs library
        const curatedVoices = [
          { name: 'Mikey', id: '3yJq5VpFXdeyF5oOBl2e' },  // Male from voice library
          { name: 'Danny', id: 'aGkVQvWUZi16EH8aZJvT' },  // Male voice
          { name: 'Alison', id: 'LtPsVjX1k0Kl4StEMZPK' },  // Female, British accent from voice library
          { name: 'Kylie', id: 'miTHcVblZMXYolDQgUgx' }  // Female voice
        ];
        
        // Check which voices from our curated list are actually available
        const availableVoices = [];
        curatedVoices.forEach(curated => {
          const found = voices.find(v => {
            const id = v.voice_id || v.id || v.voiceId;
            const name = (v.name || v.voice_name || '').toString().toLowerCase();
            return id === curated.id || name.includes(curated.name.split(' ')[0].toLowerCase());
          });
          
          if (found) {
            availableVoices.push({
              id: found.voice_id || found.id || found.voiceId,
              name: curated.name
            });
          } else {
            // Use the curated ID even if not found in list (may still work)
            availableVoices.push(curated);
          }
        });

        // Add curated voices to selector
        const voiceSelect = document.getElementById('demoVoiceSelect');
        if (voiceSelect) {
          voiceSelect.innerHTML = '';
          availableVoices.forEach((v, index) => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = v.name;
            // Set Mikey as default
            if (v.name.includes('Mikey')) {
              opt.selected = true;
            }
            voiceSelect.appendChild(opt);
          });
        }
        
        log(`Loaded ${availableVoices.length} high-quality voices`);

      }catch(e){
        log('Could not load voices: ' + e.message);
      }
    }

    // ============================================
    // TTS FUNCTION
    // ============================================
    async function speakText(text){
      // Stop any currently playing audio when switching voices mid-prompt
      const player = document.getElementById('player');
      if (isSpeaking) {
        player.pause();
        isSpeaking = false;
      }
      
      // Get voice from selector
      const voice = document.getElementById('demoVoiceSelect')?.value || '';
      
      // Ultra-realistic settings for natural human speech
      const style = 1.0;       // Maximum expressiveness
      const stability = 0.3;   // Lower for more human-like variation
      const similarity = 1.0;  // Maximum voice consistency
      
      // Don't add artificial pauses - let the TTS handle natural flow
      log('Speaking: ' + text);
      isSpeaking = true;
      try{
        const url = `/tts?text=${encodeURIComponent(text)}&voice=${encodeURIComponent(voice)}&style=${encodeURIComponent(style)}&stability=${encodeURIComponent(stability)}&similarity=${encodeURIComponent(similarity)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error('TTS failed: ' + r.status);
        const blob = await r.blob();
        const src = URL.createObjectURL(blob);
        player.playbackRate = 0.85;  // Slower for clearer pronunciation
        
        // Set up event listeners to track when audio finishes
        player.onended = () => { isSpeaking = false; };
        player.onerror = () => { isSpeaking = false; };
        
        player.src = src;
        await player.play();
      }catch(e){
        log('TTS error: ' + e.message);
        isSpeaking = false;
      }
    }

    function pauseAudio(){
      const player = document.getElementById('player');
      if (isSpeaking) {
        player.pause();
        isSpeaking = false;
        log('Audio paused');
      } else {
        log('No audio playing');
      }
    }

    function onVoiceChange(){
      const select = document.getElementById('demoVoiceSelect');
      if (!select) return;
      const voiceName = select.options[select.selectedIndex].text;
      log('Voice changed to: ' + voiceName);
      if (isSpeaking) {
        log('Current audio stopped - voice will change on next prompt');
      }
    }

    // ============================================
    // COACH ENGINE - PROMPT TEMPLATES & LOGIC
    // ============================================
    
    // All coaching prompts
    const COACH_PROMPTS = {
      motivational: {
        push: [
          "<pitch high>Let's pick it up{name}. Quick feet, strong arms, you've got this.</pitch>",
          "<pitch high>Time to accelerate. Feel that power. This is your moment.</pitch>",
          "<pitch high>Alright{name}, dig a little deeper now. Give me thirty seconds of solid effort.</pitch>",
          "<pitch high>Can you pick up the pace a bit? Show me what you're made of.</pitch>",
          "<pitch high>I see you settling in there{name}. How about we turn up the heat just a touch?</pitch>",
          "<pitch high>Increase your cadence by five steps per minute. Quick turnover, efficient movement.</pitch>",
          "<pitch high>Shorten that ground contact. Quick feet. Power through with strong strides.</pitch>",
          "<pitch high>Pick up the cadence for sixty seconds{name}. Stay light on your feet, strong form.</pitch>",
          "<pitch high>You're stronger than you think{name}, so don't give up now. This is where real progress happens.</pitch>",
          "<pitch high>Great work{name}, now pick it back up slightly and find a rhythm that feels powerful but still controlled.</pitch>",
          "<pitch high>Can you give me just ten more seconds of your best effort{name}? Really finish this interval with intention.</pitch>"
        ],
        slowDown: [
          "<pitch high>Okay{name}, breathe. Nice and easy now. Deep, controlled breaths. Settle into your rhythm.</pitch>",
          "<pitch high>Easy does it. Bring it down. Two big deep breaths for me. Feel that sweet recovery.</pitch>",
          "<pitch high>Relax those shoulders{name}. Shake it out. You're in control. Conserve that energy.</pitch>",
          "<pitch high>Perfect. Ease off now. Let your heart rate come down naturally. You've earned this recovery.</pitch>",
          "<pitch high>Whoa there, getting a bit carried away? Let's bring it back down.</pitch>",
          "<pitch high>Reduce your pace by ten percent. Slowly drop your effort. Lengthen your recovery.</pitch>",
          "<pitch high>Lower your cadence now. Longer strides. Easy, controlled breathing.</pitch>",
          "<pitch high>Back it off. Reduce your cadence. Focus on form and recovery.</pitch>",
          "<pitch high>Okay{name}, let's slow it down for a moment and gently bring your heart rate down while you keep moving.</pitch>",
          "<pitch high>Take a deep breath in{name}, and exhale slowly, letting your shoulders relax and your jaw unclench.</pitch>",
          "<pitch high>If you feel any sharp pain{name}, I want you to ease off immediately and switch to a lighter intensity.</pitch>"
        ],
        status: [
          "<pitch high>You're at {dist}{name}! Pace is {pace}, heart rate {hr}. You're looking absolutely strong out there! Keep it rolling!</pitch>",
          "<pitch high>Crushing it at {dist}! Heart rate {hr}, pace {pace}. Stay locked in and focused! You're doing incredible work!</pitch>",
          "<pitch high>Wow! {dist} down already! Pace {pace}, heart rate {hr}. This is YOUR run! Keep that beautiful energy high!</pitch>",
          "<pitch high>Look at you go! {dist} down, heart rate {hr}, pace {pace}. I mean, not bad for someone who probably hit snooze twice this morning!</pitch>",
          "<pitch high>Telemetry check: pace {pace}, heart rate {hr}, distance {dist}. Looking absolutely solid out there!</pitch>",
          "<pitch high>Segment complete at {dist}! Pace {pace}, heart rate {hr}. Keep those metrics strong!</pitch>",
          "<pitch high>Awesome pace so far, keep that energy up and stay focused on every single step you take.</pitch>"
        ]
      },
      calm: {
        push: [
          "<pitch high>Alright{name}, let's pick up the pace just a little. Nice and smooth.</pitch>",
          "<pitch high>Great work. Nudge it up just a touch. Stay controlled and relaxed.</pitch>",
          "<pitch high>Here we go, a gentle push now. Light on the feet, easy breathing.</pitch>",
          "<pitch high>Time to wake up those legs a bit{name}? Nothing crazy, just a gentle lift.</pitch>",
          "<pitch high>Hey{name}, you're doing great today. Ready to push just a little further with me?</pitch>"
        ],
        slowDown: [
          "<pitch high>Perfect{name}. Ease off gradually now. Breathe through your nose. Long, smooth breaths.</pitch>",
          "<pitch high>Excellent. Slow down just a touch{name}. Let your heart rate settle naturally.</pitch>",
          "<pitch high>Beautiful running. Take it easy now. Reduce your effort. Really controlled.</pitch>",
          "<pitch high>Easy there. Let's bring that intensity down a notch. Save some energy for when you need it.</pitch>"
        ],
        status: [
          "<pitch high>Looking great{name}. Current pace {pace}, heart rate {hr}, distance {dist}. Maintain this steady rhythm.</pitch>",
          "<pitch high>Fantastic work. At {dist} now. Keep this calm, controlled pace going.</pitch>",
          "<pitch high>Smooth running{name}. {dist} down, pace {pace}, heart rate {hr}.</pitch>",
          "<pitch high>Well well, {dist} already? Heart rate {hr}, pace {pace}. Someone's doing their homework?</pitch>",
          "<pitch high>How does your body feel right now{name}? Is your breathing steady or starting to race a bit?</pitch>"
        ],
        milestone: [
          "<pitch high>Nice work{name}. You've reached {dist}. Keep that momentum going.</pitch>",
          "<pitch high>Excellent{name}. {dist} complete. You're looking strong.</pitch>",
          "<pitch high>Great job{name}. That's {dist} down. Stay focused and keep it up.</pitch>",
          "<pitch high>{dist} in the bag{name}. Who said running was hard? Look at you!!</pitch>",
          "<pitch high>Another one done. {dist} complete{name}. You're making this look easy.</pitch>",
          "<pitch high>Nice job{name}, you crushed that round. Take a moment to be proud of yourself before we move on.</pitch>"
        ]
      }
    };
    
    const COACH_TONES = ["motivational", "calm"];
    
    // Prompt rotation state (stored in localStorage)
    let coachPromptUsage = loadPromptUsageState();
    
    function loadPromptUsageState() {
      try {
        const saved = localStorage.getItem("coach_prompt_usage");
        return saved ? JSON.parse(saved) : {};
      } catch (e) {
        return {};
      }
    }
    
    function savePromptUsageState() {
      try {
        localStorage.setItem("coach_prompt_usage", JSON.stringify(coachPromptUsage));
      } catch (e) {
        // ignore
      }
    }
    
    // Get next prompt in rotation (cycles through sequentially)
    function getNextPrompt(tone, category) {
      const toneObj = COACH_PROMPTS[tone];
      if (!toneObj) return null;
      
      const list = toneObj[category];
      if (!Array.isArray(list) || list.length === 0) return null;
      
      if (!coachPromptUsage[tone]) {
        coachPromptUsage[tone] = {};
      }
      const toneUsage = coachPromptUsage[tone];
      
      const idx = toneUsage[category] || 0;
      const prompt = list[idx % list.length];
      
      toneUsage[category] = (idx + 1) % list.length;
      savePromptUsageState();
      
      return prompt;
    }
    
    // Decide which prompt category based on metrics
    function decideCategory(metrics) {
      const paceFast = metrics.paceSecPerKm <= 300;  // faster than ~5:00/km
      const paceSlow = metrics.paceSecPerKm >= 380;  // slower than ~6:20/km
      
      const hrHigh = metrics.heartRate >= 170;
      const hrLow  = metrics.heartRate <= 130;
      
      // Too fast / too hot -> slow down
      if (hrHigh || paceFast) return "slowDown";
      
      // Too easy -> push
      if (hrLow || paceSlow) return "push";
      
      // Otherwise -> status
      return "status";
    }
    
    // Check if we hit a milestone (whole km)
    let previousDistanceKm = 0;
    
    function isMilestone(currentDistanceKm) {
      const prevWhole = Math.floor(previousDistanceKm);
      const currentWhole = Math.floor(currentDistanceKm);
      return currentWhole > prevWhole;
    }
    
    // Format helpers
    function formatDistanceKm(distKm) {
      return distKm.toFixed(2) + " km";
    }
    
    function formatPaceDisplay(secPerKm) {
      const m = Math.floor(secPerKm / 60);
      const s = Math.round(secPerKm % 60);
      return m + ":" + String(s).padStart(2, "0") + " min/km";
    }
    
    // Fill template variables
    function fillPromptTemplate(template, ctx) {
      let text = template
        .replace(/{name}/g, ctx.name ? " " + ctx.name : "")
        .replace(/{dist}/g, formatDistanceKm(ctx.distanceKm))
        .replace(/{pace}/g, formatPaceDisplay(ctx.paceSecPerKm))
        .replace(/{hr}/g, ctx.heartRate + " bpm");
      
      // Format distance decimals for TTS
      const unitText = unit === 'miles' ? ' miles' : ' kilometers';
      text = text.replace(/\b(\d+)\.(\d+)\b/gi, (match, whole, decimal) => {
        const decimalSpoken = decimal.split('').map(d => d === '0' ? 'zero' : d).join(', ');
        return `, ${whole}, point, ${decimalSpoken}, ${unitText},`;
      });
      
      // Format pace for TTS
      text = text.replace(/(\d+):(\d+)/g, (match, min, sec) => {
        const paceUnit = unit === 'miles' ? 'per mile' : 'per kilometer';
        if (sec === '00') {
          return `, ${min} minutes ${paceUnit},`;
        } else {
          const secSpoken = sec.split('').map(d => d === '0' ? 'zero' : d).join(', ');
          return `, ${min}, point, ${secSpoken}, ${paceUnit},`;
        }
      });
      
      return text;
    }
    
    // Read current metrics from UI
    function readMetricsFromUI() {
      // Get sliders
      const paceSlider = document.getElementById("paceSlider");
      const hrSlider = document.getElementById("hrSlider");
      const distSlider = document.getElementById("distSlider");
      
      if (!paceSlider || !hrSlider || !distSlider) {
        console.warn("Metric sliders not found");
        return null;
      }
      
      // Distance + unit conversion
      const distUnitText = (document.getElementById("distUnit")?.innerText || "km").toLowerCase();
      const rawDist = Number(distSlider.value) || 0;
      const distanceKm = distUnitText.includes("mile") ? rawDist * 1.60934 : rawDist;
      
      // Pace + unit conversion
      const paceUnitText = (document.getElementById("paceUnit")?.innerText || "min/km").toLowerCase();
      const paceSecPerUnit = Number(paceSlider.value) || 300;
      const unitFactor = paceUnitText.includes("/mi") ? 1.60934 : 1.0;
      const paceSecPerKm = paceSecPerUnit / unitFactor;
      
      // Heart rate
      const heartRate = Number(hrSlider.value) || 140;
      
      // Name
      const nameInput = document.getElementById("demoUserName");
      const name = nameInput ? nameInput.value.trim() : "";
      
      // Tone
      const toneSelect = document.getElementById("toneSelect");
      let tone = toneSelect ? toneSelect.value : "motivational";
      if (COACH_TONES.indexOf(tone) === -1) tone = "motivational";
      
      return {
        distanceKm,
        paceSecPerKm,
        heartRate,
        name,
        tone
      };
    }
    
    // Main function to generate a coaching line
    function generateCoachLine() {
      const metrics = readMetricsFromUI();
      if (!metrics) return null;
      
      const tone = metrics.tone;
      let category = decideCategory(metrics);
      
      // Check for milestone
      if (tone === "calm" && COACH_PROMPTS.calm.milestone && isMilestone(metrics.distanceKm)) {
        category = "milestone";
      }
      
      previousDistanceKm = metrics.distanceKm;
      
      const rawPrompt = getNextPrompt(tone, category);
      if (!rawPrompt) return null;
      
      const finalText = fillPromptTemplate(rawPrompt, {
        name: metrics.name,
        distanceKm: metrics.distanceKm,
        paceSecPerKm: metrics.paceSecPerKm,
        heartRate: metrics.heartRate
      });
      
      return finalText;
    }
    
    // Auto prompts interval
    let autoPromptIntervalId = null;
    
    function autoPromptTick() {
      const line = generateCoachLine();
      if (!line) return;
      speakText(line);
      log("üéôÔ∏è Coach: " + line.substring(0, 50) + "...");
    }
    
    function startAutoPrompts() {
      if (autoPromptIntervalId !== null) return;
      autoPromptIntervalId = setInterval(autoPromptTick, 30000);
      log("Auto prompts started (30s intervals)");
    }
    
    function stopAutoPrompts() {
      if (autoPromptIntervalId === null) return;
      clearInterval(autoPromptIntervalId);
      autoPromptIntervalId = null;
      log("Auto prompts stopped");
    }
    
    function triggerSinglePrompt() {
      const line = generateCoachLine();
      if (!line) return;
      speakText(line);
      log("üéôÔ∏è Test: " + line.substring(0, 50) + "...");
    }

    // ============================================
    // DISPLAY UPDATES
    // ============================================
    function updateDisplays(){
      const displayDist = unit === 'miles' ? kmToMiles(dist) : dist;
      const displayUnit = unit === 'miles' ? 'min/mi' : 'min/km';
      
      document.getElementById('paceDisplay').textContent = secToMinSec(pace);
      document.getElementById('hrDisplay').textContent = Math.round(hr);
      document.getElementById('distDisplay').textContent = displayDist.toFixed(2);
      document.getElementById('timeDisplay').textContent = secToMinSec(time);
      document.getElementById('paceUnit').textContent = displayUnit;
      document.getElementById('distUnit').textContent = unit;
      
      // Update heart icon color based on HR zones (% of HRmax)
      const zone = getHRZone(hr, hrMax);
      const heartIcon = document.getElementById('heartIcon');
      heartIcon.className = 'heart-icon';
      heartIcon.style.color = zone.color;
      
      // Check for HR safety warnings
      const safety = checkHRSafety(hr, hrMax);
      if (safety && running) {
        speakText(safety.message);
        log(`‚ö†Ô∏è HR Safety: ${safety.level} - Zone ${zone.zone}`);
      }
    }

    function updateUnits(){
      unit = document.getElementById('demoUnitSelect')?.value || 'km';
      updateDisplays();
      log('Units changed to ' + unit);
    }

    function updateRangeDisplay(id, value){
      document.getElementById(id + 'Value').textContent = value;
    }

    function updateUserName(){
      userName = document.getElementById('demoUserName')?.value.trim() || '';
      log('Name updated to: ' + (userName || 'None'));
    }

    function updateAge(){
      userAge = Number(document.getElementById('demoUserAge')?.value) || 30;
      hrMax = 220 - userAge;
      log(`Age: ${userAge}, Max HR: ${hrMax}`);
    }

    function getHRZone(hr, hrMax) {
      const pct = hr / hrMax;
      if (pct < 0.6) return { zone: 1, name: "Very Easy", color: "#3b82f6" };
      if (pct < 0.7) return { zone: 2, name: "Easy", color: "#10b981" };
      if (pct < 0.8) return { zone: 3, name: "Moderate", color: "#fbbf24" };
      if (pct < 0.9) return { zone: 4, name: "Hard", color: "#f97316" };
      return { zone: 5, name: "Very Hard", color: "#dc2626" };
    }

    function checkHRSafety(hr, hrMax) {
      const pct = hr / hrMax;
      const now = Date.now();
      
      // Danger: > 95% HRmax (immediate warning, but only once per 30s)
      if (pct > 0.95) {
        const timeSinceLastWarning = (now - lastHrWarningTime.danger) / 1000;
        if (timeSinceLastWarning >= 30) {
          lastHrWarningTime.danger = now;
          return {
            level: 'danger',
            message: "Your heart rate is extremely high. Stop running now and walk slowly. If you feel unwell, seek medical help."
          };
        }
        return null;
      }
      
      // Hard warning: > 90% HRmax (after 30s sustained, then repeat every 30s)
      if (pct > 0.9) {
        if (!highHrStartTime) highHrStartTime = now;
        const duration = (now - highHrStartTime) / 1000;
        const timeSinceLastWarning = (now - lastHrWarningTime.warning) / 1000;
        
        if (duration > 30 && timeSinceLastWarning >= 30) {
          lastHrWarningTime.warning = now;
          return {
            level: 'warning',
            message: "Your heart rate is very high. Please slow down or walk until your heart rate drops back to a comfortable level."
          };
        }
        return null;
      }
      
      // Caution: > 85% HRmax (after 60s sustained, then repeat every 30s)
      if (pct > 0.85) {
        if (!highHrStartTime) highHrStartTime = now;
        const duration = (now - highHrStartTime) / 1000;
        const timeSinceLastWarning = (now - lastHrWarningTime.caution) / 1000;
        
        if (duration > 60 && timeSinceLastWarning >= 30) {
          lastHrWarningTime.caution = now;
          return {
            level: 'caution',
            message: "You're working pretty hard now. If this isn't intentional, try slowing your pace."
          };
        }
        return null;
      } else {
        // Reset timer when HR drops below 85%
        highHrStartTime = null;
      }
      
      return null;
    }

    // ============================================
    // RUN CONTROLS
    // ============================================
    function toggleRun(){
      // Always stop first to prevent multiple intervals
      stopRun();
      
      running = !running;
      const btn = document.getElementById('startBtn');
      if (running) {
        btn.textContent = '‚è∏Ô∏è Pause';
        btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        startRun();
        log('Run started');
      } else {
        btn.textContent = '‚ñ∂Ô∏è Start';
        btn.style.background = 'linear-gradient(135deg, var(--btn-primary-start) 0%, var(--btn-primary-end) 100%)';
        log('Run paused');
      }
    }

    function startRun(){
      runInterval = setInterval(() => {
        time++;
        dist += (1 / pace) / 60;
        hr = Math.round(Math.max(60, Math.min(200, hr + (Math.random() - 0.5) * 3)));
        
        // Check for kilometer/mile milestones
        const currentKm = Math.floor(dist);
        if (currentKm > lastKmMilestone && currentKm > 0) {
          lastKmMilestone = currentKm;
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('üéØ Milestone: ' + currentKm + ' km');
          }
        }
        
        updateDisplays();
      }, 1000);
    }

    function stopRun(){
      if (runInterval) {
        clearInterval(runInterval);
        runInterval = null;
      }
    }

    function randomizeTelemetry(){
      pace = Math.floor(Math.random() * 300) + 240; // 4:00-9:00
      hr = Math.floor(Math.random() * 80) + 120; // 120-200
      dist = Math.random() * 10; // 0-10km
      updateDisplays();
      log('Telemetry randomized');
    }

    function testVoice(){
      triggerSinglePrompt();
    }

    function speakManual(){
      const text = document.getElementById('demoManualText')?.value || "Keep going!";
      speakText(text);
    }

    function toggleAuto(){
      const checkbox = document.getElementById('autoPromptsToggle');
      auto = checkbox ? checkbox.checked : !auto;
      log('Auto prompts ' + (auto ? 'enabled' : 'disabled'));
    }

    // ============================================
    // MANUAL PROMPT TRIGGERS
    // ============================================
    let lastPromptTrigger = { milestone: 0, hr: 0, pace: 0, status: 0 };
    let lastSliderValues = { pace: 300, hr: 140, dist: 0 }; // Track previous values
    
    function triggerPrompts(){
      const now = Date.now();
      const targetPace = parseMinSec(document.getElementById('demoTargetPace')?.value || '5:00');
      const hrTarget = Number(document.getElementById('demoTargetHR')?.value) || 150;
      const hrPct = hr / hrMax;
      
      // Detect which slider changed significantly
      const paceChange = Math.abs(pace - lastSliderValues.pace);
      const hrChange = Math.abs(hr - lastSliderValues.hr);
      const distChange = Math.abs(dist - lastSliderValues.dist);
      
      // Update last values
      lastSliderValues = { pace, hr, dist };
      
      // PACE SLIDER TRIGGERS
      if (paceChange > 20 && (now - lastPromptTrigger.pace > 5000)) {
        lastPromptTrigger.pace = now;
        
        // Pace too slow - push motivation
        if (pace > targetPace + 30) {
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('‚ö° Pace changed: Too slow - motivation');
          }
          updateDemoDisplay();
          return;
        }
        // Pace improved - status update
        else if (pace < targetPace - 20) {
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('‚úÖ Pace changed: Great pace!');
          }
          updateDemoDisplay();
          return;
        }
      }
      
      // HR SLIDER TRIGGERS
      if (hrChange > 10 && (now - lastPromptTrigger.hr > 5000)) {
        lastPromptTrigger.hr = now;
        
        // HR too high - slow down
        if (hrPct > 0.90) {
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('‚ö†Ô∏è HR changed: Too high - slow down');
          }
          updateDemoDisplay();
          return;
        }
        // HR in good zone - positive feedback
        else if (hrPct >= 0.70 && hrPct <= 0.85) {
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('üíö HR changed: Perfect zone!');
          }
          updateDemoDisplay();
          return;
        }
        // HR too low - push harder
        else if (hrPct < 0.65 && dist > 1.0) {
          const msg = generateCoachLine();
          if (msg) {
            speakText(msg);
            log('‚ö° HR changed: Too low - push harder');
          }
          updateDemoDisplay();
          return;
        }
      }
      
      // DISTANCE SLIDER TRIGGERS
      // Check for kilometer milestones
      const currentKm = Math.floor(dist);
      if (currentKm > 0 && currentKm !== lastPromptTrigger.milestone && (now - lastPromptTrigger.milestone > 3000)) {
        lastPromptTrigger.milestone = currentKm;
        const msg = generateCoachLine();
        if (msg) {
          speakText(msg);
          log(`üéØ Milestone: ${currentKm} ${unit}`);
        }
        updateDemoDisplay();
        return;
      }
      
      // Status updates at major milestones (5, 10, 15, 20 km)
      if ([5, 10, 15, 20].includes(currentKm) && currentKm !== lastPromptTrigger.status && (now - lastPromptTrigger.status > 3000)) {
        lastPromptTrigger.status = currentKm;
        const msg = chooseTemplate('status', {
          pace: secToMinSec(pace),
          hr: hr,
          dist: (unit === 'miles' ? kmToMiles(dist) : dist).toFixed(2)
        });
        speakText(msg);
        log(`üìä Status update: ${currentKm}km`);
        updateDemoDisplay();
        return;
      }
      
      updateDemoDisplay();
    }
    
    function updateDemoDisplay(){
      document.getElementById('demoPhase').textContent = getPhase();
      document.getElementById('demoDistance').textContent = (unit === 'miles' ? kmToMiles(dist) : dist).toFixed(2) + ' ' + unit;
      document.getElementById('demoPace').textContent = secToMinSec(pace) + ' /' + unit;
      document.getElementById('demoHR').textContent = hr + ' bpm';
      document.getElementById('demoTime').textContent = secToMinSec(time);
      
      const progress = (dist / 21.0) * 100;
      document.getElementById('demoProgressFill').style.width = Math.min(progress, 100) + '%';
    }
    
    function getPhase(){
      if (dist < 1) return 'Warm-up';
      if (dist < 3) return 'Easy pace';
      if (dist < 5) return 'Finding rhythm';
      if (dist < 8) return 'Steady tempo';
      if (dist < 10.5) return 'Halfway push';
      if (dist < 13) return 'Recovery phase';
      if (dist < 16) return 'Building up';
      if (dist < 18) return 'Strong push';
      if (dist < 20) return 'Almost there';
      if (dist >= 21) return 'Complete!';
      return 'Final push!';
    }

    // ============================================
    // AUTO PROMPTS - handled by coach engine
    // ============================================
    // Auto prompts are now managed by startAutoPrompts/stopAutoPrompts functions

    // ============================================
    // INITIALIZATION
    // ============================================
    updateAge();
    updateDisplays();
    loadVoices();
    log('Dashboard ready');

    // ============================================
    // DEMO MODE
    // ============================================
    // DEMO RESET
    // ============================================
    function resetDemo(){
      pace = 300;
      hr = 140;
      dist = 0;
      time = 0;
      lastPromptTrigger = { milestone: 0, hr: 0, pace: 0, status: 0 };
      lastKmMilestone = 0;
      
      // Reset sliders
      document.querySelectorAll('.metric-slider').forEach((slider, idx) => {
        if (idx === 0) slider.value = 300; // pace
        if (idx === 1) slider.value = 140; // hr
        if (idx === 2) slider.value = 0;   // dist
        if (idx === 3) slider.value = 0;   // time
      });
      
      updateDisplays();
      updateDemoDisplay();
      log('üîÑ Reset complete');
    }

    // ============================================
    // MODE TOGGLE (DEMO vs LIVE)
    // ============================================
    function toggleMode() {
      isLiveMode = !isLiveMode;
      const btn = document.getElementById('modeToggleBtn');
      const icon = document.getElementById('modeIcon');
      const title = document.getElementById('modeTitle');
      const info = document.getElementById('modeInfo');
      const sliders = document.querySelectorAll('.metric-slider');
      const connectBtn = document.getElementById('connectDeviceBtn');
      
      if (isLiveMode) {
        // Switch to LIVE mode
        btn.textContent = 'üé¨ Switch to Demo Mode';
        icon.textContent = 'üì°';
        title.textContent = 'Live Mode';
        info.textContent = 'Connect your fitness device to receive real-time coaching during your workout.';
        
        // Hide sliders in live mode
        sliders.forEach(slider => {
          slider.style.display = 'none';
        });
        
        // Show connect device button if not connected
        if (!vitalConnected) {
          connectBtn.style.display = 'inline-block';
        }
        
        log('üì° Switched to Live Mode');
      } else {
        // Switch to DEMO mode
        btn.textContent = 'üì° Switch to Live Mode';
        icon.textContent = 'üé¨';
        title.textContent = 'Demo Mode';
        info.textContent = 'Control your virtual 21K (half marathon) run. Adjust metrics to trigger different coaching prompts.';
        
        // Show sliders in demo mode
        sliders.forEach(slider => {
          slider.style.display = 'block';
        });
        
        connectBtn.style.display = 'none';
        
        log('üé¨ Switched to Demo Mode');
      }
    }

    // ============================================
    // VITAL API INTEGRATION
    // ============================================
    async function connectVitalDevice() {
      try {
        log('‚è≥ Getting link token...');
        
        // Get link token from backend
        const response = await fetch('/vital/link-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ client_user_id: 'demo-user-' + Date.now() })
        });
        
        if (!response.ok) throw new Error('Failed to get link token');
        
        const data = await response.json();
        vitalUserId = data.user_id;
        
        // Open Link Web URL in popup
        const linkUrl = data.link_web_url;
        const width = 500;
        const height = 700;
        const left = (screen.width / 2) - (width / 2);
        const top = (screen.height / 2) - (height / 2);
        
        const popup = window.open(
          linkUrl,
          'VitalLink',
          `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );
        
        if (!popup) {
          throw new Error('Popup blocked. Please allow popups for this site.');
        }
        
        // Listen for popup close or message
        const checkPopup = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkPopup);
            // Assume success if popup was closed
            vitalConnected = true;
            document.getElementById('terraDeviceName').textContent = 'Device';
            document.getElementById('terraStatus').style.display = 'block';
            document.getElementById('connectDeviceBtn').style.display = 'none';
            
            // Connect WebSocket for real-time data
            connectWebSocket();
            
            log('‚úÖ Device connected');
          }
        }, 500);
        
      } catch (error) {
        log('‚ùå Vital connection error: ' + error.message);
      }
    }

    function disconnectVital() {
      if (ws) {
        ws.close();
        ws = null;
      }
      
      vitalConnected = false;
      vitalUserId = null;
      document.getElementById('terraStatus').style.display = 'none';
      
      if (isLiveMode) {
        document.getElementById('connectDeviceBtn').style.display = 'inline-block';
      }
      
      log('‚ùå Disconnected from device');
    }

    // ============================================
    // WEBSOCKET FOR REAL-TIME DATA
    // ============================================
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws?userId=${vitalUserId}`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        log('üîó Real-time data stream connected');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          // Update metrics with real data from Terra
          if (data.heart_rate !== undefined) {
            hr = data.heart_rate;
          }
          
          if (data.pace_sec_per_km !== undefined) {
            pace = data.pace_sec_per_km;
          }
          
          if (data.distance_km !== undefined) {
            dist = data.distance_km;
          }
          
          if (data.elapsed_time_sec !== undefined) {
            time = data.elapsed_time_sec;
          }
          
          // Update display
          updateDisplays();
          triggerPrompts();
          
        } catch (error) {
          console.error('WebSocket data error:', error);
        }
      };
      
      ws.onerror = (error) => {
        log('‚ùå WebSocket error');
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = () => {
        log('üîå Real-time data stream disconnected');
      };
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Auto Prompts toggle
      var autoToggle = document.getElementById("autoPromptsToggle");
      if (autoToggle) {
        autoToggle.addEventListener("change", function (e) {
          if (e.target.checked) {
            startAutoPrompts();
          } else {
            stopAutoPrompts();
          }
        });
      }

      // Start Test Voice button -> single prompt
      var startBtn = document.getElementById("startTestBtn");
      if (startBtn) {
        startBtn.addEventListener("click", function () {
          triggerSinglePrompt();
        });
      }
    });
  </script>
</body>
</html>
