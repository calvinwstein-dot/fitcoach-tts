<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitCoach Dashboard</title>
  <style>
    /* ============================================
       COLOR CONFIGURATION - CHANGE THESE VALUES
       ============================================ */
    :root {
      /* Background Gradient */
      --bg-gradient-start: #667eea;    /* Purple */
      --bg-gradient-end: #764ba2;      /* Dark Purple */
      
      /* Primary Button (Start/Stop/Settings) */
      --btn-primary-start: #667eea;    /* Purple */
      --btn-primary-end: #764ba2;      /* Dark Purple */
      
      /* Secondary Button (Randomize/Test) */
      --btn-secondary-start: #f093fb;  /* Pink */
      --btn-secondary-end: #f5576c;    /* Red-Pink */
      
      /* Metric Value Color (Pace, HR, Distance, Time) */
      --metric-color: #667eea;         /* Purple */
      
      /* Card Background */
      --card-bg: rgba(255,255,255,0.95); /* White with transparency */
      
      /* Text Colors */
      --text-primary: #333;            /* Dark gray */
      --text-muted: #888;              /* Medium gray */
      --text-white: #fff;              /* White */
    }
    
    /* ============================================
       GENERAL STYLES
       ============================================ */
    * { box-sizing: border-box; }
    body { 
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
      margin: 0; 
      padding: 20px;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-white);
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
    }
    h1 { margin: 0; color: var(--text-white); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    /* Main Metrics Card */
    .metrics-card { 
      padding: 32px; 
      border-radius: 16px; 
      background: var(--card-bg); 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      margin-bottom: 20px;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 32px;
      text-align: center;
    }
    .metric-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .metric-label { 
      font-size: 14px; 
      color: var(--text-muted); 
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .metric-value { 
      font-size: 3rem; 
      font-weight: 700; 
      color: var(--metric-color);
      line-height: 1;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .heart-icon {
      font-size: 2.5rem;
      animation: heartbeat 1.2s ease-in-out infinite;
    }
    .heart-zone-1 { color: #3b82f6; } /* Blue - 120 */
    .heart-zone-2 { color: #fbbf24; } /* Yellow - 140 */
    .heart-zone-3 { color: #f97316; } /* Orange - 160 */
    .heart-zone-4 { color: #dc2626; } /* Deep Red - 180+ */
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      10% { transform: scale(1.1); }
      20% { transform: scale(1); }
      30% { transform: scale(1.1); }
      40% { transform: scale(1); }
    }
    .metric-unit { 
      font-size: 13px; 
      color: var(--text-muted);
    }
    .metric-slider {
      width: 100%;
      margin-top: 8px;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: #e0e0e0;
      outline: none;
    }
    .metric-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--metric-color);
      cursor: pointer;
    }
    .metric-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--metric-color);
      cursor: pointer;
      border: none;
    }
    
    /* Control Buttons */
    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    button { 
      padding: 14px 28px; 
      border-radius: 10px; 
      border: none; 
      background: linear-gradient(135deg, var(--btn-primary-start) 0%, var(--btn-primary-end) 100%); 
      color: white; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    button:active { transform: translateY(0); }
    button.secondary { 
      background: linear-gradient(135deg, var(--btn-secondary-start) 0%, var(--btn-secondary-end) 100%); 
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }
    button.secondary:hover { box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4); }
    button.settings {
      padding: 10px 20px;
      font-size: 24px;
      background: rgba(255,255,255,0.2);
      box-shadow: none;
    }
    button.settings:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    
    /* Settings Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text-primary);
      box-shadow: 0 16px 64px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-header h2 {
      margin: 0;
      color: var(--text-primary);
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      box-shadow: none;
    }
    .close-btn:hover {
      color: var(--text-primary);
      transform: none;
    }
    .setting-group {
      margin-bottom: 20px;
    }
    .setting-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 14px;
    }
    .setting-group select,
    .setting-group input[type="text"],
    .setting-group input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .setting-group input[type="range"] {
      width: 100%;
    }
    .setting-group select:focus,
    .setting-group input:focus {
      outline: none;
      border-color: var(--metric-color);
    }
    .range-value {
      text-align: center;
      font-weight: 600;
      color: var(--metric-color);
      margin-top: 4px;
    }
    
    /* Event Log */
    .log-card {
      padding: 20px;
      border-radius: 12px;
      background: var(--card-bg);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      color: var(--text-primary);
    }
    .log-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--text-primary);
    }
    .log { 
      height: 150px; 
      overflow: auto; 
      background: #f8f9fa; 
      padding: 12px; 
      border-radius: 8px; 
      border: 2px solid #e0e0e0;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }
    .log div { 
      margin-bottom: 4px; 
      color: var(--text-muted);
    }
    
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .metric-value { font-size: 2.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>FitCoach</h1>
      <button class="settings" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <!-- Main Metrics Display -->
    <div class="metrics-card">
      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-label">Avg Pace</div>
          <div class="metric-value" id="paceDisplay">5:00</div>
          <div class="metric-unit" id="paceUnit">min/km</div>
          <input type="range" class="metric-slider" min="240" max="600" value="300" step="5" oninput="pace=Number(this.value); updateDisplays()" title="Adjust pace">
        </div>
        <div class="metric-item">
          <div class="metric-label">Heart Rate</div>
          <div class="metric-value">
            <span id="hrDisplay">140</span>
            <span class="heart-icon" id="heartIcon">‚ù§Ô∏è</span>
          </div>
          <div class="metric-unit">bpm</div>
          <input type="range" class="metric-slider" min="60" max="200" value="140" step="1" oninput="hr=Number(this.value); updateDisplays()" title="Adjust heart rate">
        </div>
        <div class="metric-item">
          <div class="metric-label">Distance</div>
          <div class="metric-value" id="distDisplay">0.00</div>
          <div class="metric-unit" id="distUnit">km</div>
          <input type="range" class="metric-slider" min="0" max="20" value="0" step="0.1" oninput="dist=Number(this.value); updateDisplays()" title="Adjust distance">
        </div>
        <div class="metric-item">
          <div class="metric-label">Time</div>
          <div class="metric-value" id="timeDisplay">0:00</div>
          <div class="metric-unit">min:sec</div>
          <input type="range" class="metric-slider" min="0" max="7200" value="0" step="1" oninput="time=Number(this.value); updateDisplays()" title="Adjust time">
        </div>
      </div>
      
      <div class="controls">
        <button id="startBtn" onclick="toggleRun()">‚ñ∂Ô∏è Start</button>
        <button class="secondary" onclick="testVoice()">üîä Test Voice</button>
      </div>
    </div>

    <!-- Event Log -->
    <div class="log-card">
      <h3>Event Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn" onclick="closeSettings()">√ó</button>
      </div>

      <div class="setting-group">
        <label>Your Name (Optional)</label>
        <input type="text" id="userName" placeholder="Enter your name" oninput="updateUserName()">
      </div>

      <div class="setting-group">
        <label>Your Age (for HR zones)</label>
        <input type="number" id="userAge" value="30" min="18" max="100" oninput="updateAge()">
      </div>

      <div class="setting-group">
        <label>Voice</label>
        <select id="voiceSelect"></select>
      </div>

      <div class="setting-group">
        <label>Distance Unit</label>
        <select id="unitSelect" onchange="updateUnits()">
          <option value="km">Kilometers</option>
          <option value="miles">Miles</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Target Pace</label>
        <input type="text" id="targetPace" value="5:00" placeholder="5:00">
      </div>

      <div class="setting-group">
        <label>Target Heart Rate (bpm)</label>
        <input type="number" id="targetHR" value="150" min="60" max="200">
      </div>

      <div class="setting-group">
        <label>Auto Prompts</label>
        <button id="toggleAutoBtn" onclick="toggleAuto()">Enable</button>
      </div>

      <div class="setting-group">
        <label>Manual Prompt</label>
        <input type="text" id="manualText" placeholder="Type a custom message">
        <button onclick="speakManual()" style="margin-top: 8px; width: 100%;">Speak</button>
      </div>
    </div>
  </div>

  <audio id="player" style="display:none"></audio>

  <script>
    // ============================================
    // STATE & CONFIGURATION
    // ============================================
    let pace = 300; // seconds per km (5:00)
    let hr = 140;
    let dist = 0.0;
    let time = 0; // seconds
    let auto = false;
    let running = false;
    let voices = [];
    let unit = 'km'; // 'km' or 'miles'
    let runInterval = null;
    let userName = '';
    let lastKmMilestone = 0;
    let userAge = 30; // Default age
    let hrMax = 190; // Will be calculated from age
    let highHrStartTime = null; // Track when HR goes too high
    let isSpeaking = false; // Track if audio is currently playing
    let usedPrompts = {}; // Track which prompts have been used
    let lastHrWarningTime = { caution: 0, warning: 0, danger: 0 }; // Track last warning per zone

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    const secToMinSec = s => {
      const m = Math.floor(s/60);
      const sec = Math.round(s%60).toString().padStart(2,'0');
      return m + ':' + sec;
    }

    const parseMinSec = (str) => {
      const parts = String(str).split(':').map(p=>Number(p));
      if (parts.length===2) return parts[0]*60 + parts[1];
      return Number(str);
    }

    const kmToMiles = km => km * 0.621371;
    const milesToKm = miles => miles / 0.621371;

    function log(msg){
      const t = new Date().toLocaleTimeString();
      document.getElementById('log').innerHTML = `<div>[${t}] ${msg}</div>` + document.getElementById('log').innerHTML;
    }

    // ============================================
    // VOICE LOADING
    // ============================================
    async function loadVoices(){
      try{
        const r = await fetch('/voices');
        if (!r.ok) {
          log('Voices API error: ' + r.status);
          return;
        }
        const data = await r.json();
        voices = Array.isArray(data) ? data : (data.voices || []);
        
        // Curated selection: Custom voice from ElevenLabs library
        const curatedVoices = [
          { name: 'Mikey', id: '3yJq5VpFXdeyF5oOBl2e' },  // Male from voice library
          { name: 'Danny', id: 'd9rRtAT3qedrNbvmbykg' },  // Male voice
          { name: 'Alison', id: '3yJq5VpFXdeyF5oOBl2e' },  // Female, British accent from voice library
          { name: 'Kylie', id: 'miTHcVblZMXYolDQgUgx' }  // Female voice
        ];

        const select = document.getElementById('voiceSelect');
        select.innerHTML = '';
        
        // Check which voices from our curated list are actually available
        const availableVoices = [];
        curatedVoices.forEach(curated => {
          const found = voices.find(v => {
            const id = v.voice_id || v.id || v.voiceId;
            const name = (v.name || v.voice_name || '').toString().toLowerCase();
            return id === curated.id || name.includes(curated.name.split(' ')[0].toLowerCase());
          });
          
          if (found) {
            availableVoices.push({
              id: found.voice_id || found.id || found.voiceId,
              name: curated.name
            });
          } else {
            // Use the curated ID even if not found in list (may still work)
            availableVoices.push(curated);
          }
        });

        // Add curated voices to selector
        availableVoices.forEach((v, index) => {
          const opt = document.createElement('option');
          opt.value = v.id;
          opt.textContent = v.name;
          // Set Mikey as default
          if (v.name.includes('Mikey')) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
        
        log(`Loaded ${availableVoices.length} high-quality voices`);

      }catch(e){
        log('Could not load voices: ' + e.message);
      }
    }

    // ============================================
    // TTS FUNCTION
    // ============================================
    async function speakText(text){
      // Don't speak if already speaking
      if (isSpeaking) {
        log('Skipping speech - already playing');
        return;
      }
      
      const voice = document.getElementById('voiceSelect').value || '';
      // Ultra-realistic settings for natural human speech
      const style = 1.0;       // Maximum expressiveness
      const stability = 0.3;   // Lower for more human-like variation
      const similarity = 1.0;  // Maximum voice consistency
      
      // Don't add artificial pauses - let the TTS handle natural flow
      log('Speaking: ' + text);
      isSpeaking = true;
      try{
        const url = `/tts?text=${encodeURIComponent(text)}&voice=${encodeURIComponent(voice)}&style=${encodeURIComponent(style)}&stability=${encodeURIComponent(stability)}&similarity=${encodeURIComponent(similarity)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error('TTS failed: ' + r.status);
        const blob = await r.blob();
        const src = URL.createObjectURL(blob);
        const player = document.getElementById('player');
        player.playbackRate = 0.85;  // Slower for clearer pronunciation
        
        // Set up event listeners to track when audio finishes
        player.onended = () => { isSpeaking = false; };
        player.onerror = () => { isSpeaking = false; };
        
        player.src = src;
        await player.play();
      }catch(e){
        log('TTS error: ' + e.message);
        isSpeaking = false;
      }
    }

    // ============================================
    // PROMPT TEMPLATES
    // ============================================
    const templates = {
      motivational: {
        push: [
          "<pitch medium>Let's pick it up{name}. Quick feet, strong arms, you've got this.</pitch>",
          "<pitch medium>Time to accelerate. Feel that power. This is your moment.</pitch>",
          "<pitch medium>Alright{name}, dig a little deeper now. Give me thirty seconds of solid effort.</pitch>",
          "<pitch medium-high>Can you pick up the pace a bit? Show me what you're made of.</pitch-high>",
          "<pitch medium>I see you settling in there{name}. How about we turn up the heat just a touch?</pitch>",
          "<pitch medium>Increase your cadence by five steps per minute. Quick turnover, efficient movement.</pitch>",
          "<pitch medium>Shorten that ground contact. Quick feet. Power through with strong strides.</pitch>",
          "<pitch medium>Pick up the cadence for sixty seconds{name}. Stay light on your feet, strong form.</pitch>",
          "<pitch medium>You're stronger than you think, so don't give up now. This is where real progress happens.</pitch>",
          "<pitch medium>Great work, now pick it back up slightly and find a rhythm that feels powerful but still controlled.</pitch>",
          "<pitch medium-high>Can you give me just ten more seconds of your best effort? Really finish this interval with intention.</pitch-high>"
        ],
        slowDown: [
          "<pitch low>Okay{name}, breathe. Nice and easy now. Deep, controlled breaths. Settle into your rhythm.</pitch>",
          "<pitch low>Easy does it. Bring it down. Two big deep breaths for me. Feel that sweet recovery.</pitch>",
          "<pitch low>Relax those shoulders{name}. Shake it out. You're in control. Conserve that energy.</pitch>",
          "<pitch low>Perfect. Ease off now. Let your heart rate come down naturally. You've earned this recovery.</pitch>",
          "<pitch medium-high>Whoa there, getting a bit carried away? Let's bring it back down.</pitch-high>",
          "<pitch low>Reduce your pace by ten percent. Slowly drop your effort. Lengthen your recovery.</pitch>",
          "<pitch low>Lower your cadence now. Longer strides. Easy, controlled breathing.</pitch>",
          "<pitch low>Back it off. Reduce your cadence. Focus on form and recovery.</pitch>",
          "<pitch low>Okay, let's slow it down for a moment and gently bring your heart rate down while you keep moving.</pitch>",
          "<pitch low>Take a deep breath in, and exhale slowly, letting your shoulders relax and your jaw unclench.</pitch>",
          "<pitch low>If you feel any sharp pain, I want you to ease off immediately and switch to a lighter intensity.</pitch>"
        ],
        status: [
          "You're at {dist}{name}! Pace is {pace}, heart rate {hr}. You're looking absolutely strong out there! Keep it rolling!",
          "Crushing it at {dist}! Heart rate {hr}, pace {pace}. Stay locked in and focused! You're doing incredible work!",
          "Wow! {dist} down already! Pace {pace}, heart rate {hr}. This is YOUR run! Keep that beautiful energy high!",
          "Look at you go! {dist} down, heart rate {hr}, pace {pace}. I mean, not bad for someone who probably hit snooze twice this morning!",
          "Telemetry check: pace {pace}, heart rate {hr}, distance {dist}. Looking absolutely solid out there!",
          "Segment complete at {dist}! Pace {pace}, heart rate {hr}. Keep those metrics strong!",
          "<pitch medium>Awesome pace so far, keep that energy up and stay focused on every single step you take.</pitch>"
        ]
      },
      calm: {
        push: [
          "<pitch medium>Alright{name}, let's pick up the pace just a little. Nice and smooth.</pitch>",
          "<pitch medium>Great work. Nudge it up just a touch. Stay controlled and relaxed.</pitch>",
          "<pitch medium>Here we go, a gentle push now. Light on the feet, easy breathing.</pitch>",
          "<pitch medium-high>Time to wake up those legs a bit{name}? Nothing crazy, just a gentle lift.</pitch-high>",
          "<pitch medium-high>Hey, you're doing great today. Ready to push just a little further with me?</pitch-high>"
        ],
        slowDown: [
          "<pitch low>Perfect{name}. Ease off gradually now. Breathe through your nose. Long, smooth breaths.</pitch>",
          "<pitch low>Excellent. Slow down just a touch{name}. Let your heart rate settle naturally.</pitch>",
          "<pitch low>Beautiful running. Take it easy now. Reduce your effort. Really controlled.</pitch>",
          "<pitch low>Easy there. Let's bring that intensity down a notch. Save some energy for later.</pitch>"
        ],
        status: [
          "<pitch medium>Looking great{name}. Current pace {pace}, heart rate {hr}, distance {dist}. Maintain this steady rhythm.</pitch>",
          "<pitch medium>Fantastic work. At {dist} now. Keep this calm, controlled pace going.</pitch>",
          "<pitch medium>Smooth running{name}. {dist} down, pace {pace}, heart rate {hr}.</pitch>",
          "<pitch medium-high>Well well, {dist} already? Heart rate {hr}, pace {pace}. Someone's doing their homework.</pitch-high>",
          "<pitch medium-high>How does your body feel right now? Is your breathing steady or starting to race a bit?</pitch-high>"
        ],
        milestone: [
          "<pitch medium>Nice work{name}. You've reached {dist}. Keep that momentum going.</pitch>",
          "<pitch medium>Excellent{name}. {dist} complete. You're looking strong.</pitch>",
          "<pitch medium>Great job{name}. That's {dist} down. Stay focused and keep it up.</pitch>",
          "<pitch medium-high>{dist} in the bag{name}. Who said running was hard? Look at you.</pitch-high>",
          "<pitch medium>Another one done. {dist} complete{name}. You're making this look easy.</pitch>",
          "<pitch medium>Nice job, you crushed that round. Take a moment to be proud of yourself before we move on.</pitch>"
        ]
      }
    }

    function chooseTemplate(kind, vars={}, forceStyle=null){
      // Use motivational/technical combined style only when pace is too slow (>7:30 = 450 seconds)
      const usePushStyle = forceStyle === 'push' || (kind === 'push' && pace > 450);
      const style = usePushStyle ? 'motivational' : 'calm';
      const styleSet = templates[style] || templates['calm'];
      const arr = styleSet[kind] || [kind];
      let t = arr[Math.floor(Math.random()*arr.length)];
      
      // Replace variables
      t = t.replace(/\{(\w+)\}/g,(m,k)=>vars[k] ?? m);
      
      // Replace name (add space before name if it exists, otherwise empty)
      t = t.replace(/\{name\}/g, userName ? ' ' + userName : '');
      
      // Add unit after distance values and format decimals clearly
      const unitText = unit === 'miles' ? ' miles' : ' kilometers';
      
      // Format any standalone distance numbers (with decimals) - match number.number pattern
      t = t.replace(/\b(\d+)\.(\d+)\b/gi, (match, whole, decimal) => {
        const decimalSpoken = decimal.split('').map(d => d).join(', ');
        return `, ${whole}, point, ${decimalSpoken}, ${unitText},`;
      });
      
      // Format pace with "point" for decimals (e.g., "5:30" -> "5 point 30 per kilometer")
      t = t.replace(/(\d+):(\d+)/g, (match, min, sec) => {
        const paceUnit = unit === 'miles' ? 'per mile' : 'per kilometer';
        if (sec === '00') {
          return `, ${min} minutes ${paceUnit},`;
        } else {
          return `, ${min}, point, ${sec}, ${paceUnit},`;
        }
      });
      
      return t;
    }

    // ============================================
    // DISPLAY UPDATES
    // ============================================
    function updateDisplays(){
      const displayDist = unit === 'miles' ? kmToMiles(dist) : dist;
      const displayUnit = unit === 'miles' ? 'min/mi' : 'min/km';
      
      document.getElementById('paceDisplay').textContent = secToMinSec(pace);
      document.getElementById('hrDisplay').textContent = Math.round(hr);
      document.getElementById('distDisplay').textContent = displayDist.toFixed(2);
      document.getElementById('timeDisplay').textContent = secToMinSec(time);
      document.getElementById('paceUnit').textContent = displayUnit;
      document.getElementById('distUnit').textContent = unit;
      
      // Update heart icon color based on HR zones (% of HRmax)
      const zone = getHRZone(hr, hrMax);
      const heartIcon = document.getElementById('heartIcon');
      heartIcon.className = 'heart-icon';
      heartIcon.style.color = zone.color;
      
      // Check for HR safety warnings
      const safety = checkHRSafety(hr, hrMax);
      if (safety && running) {
        speakText(safety.message);
        log(`‚ö†Ô∏è HR Safety: ${safety.level} - Zone ${zone.zone}`);
      }
    }

    function updateUnits(){
      unit = document.getElementById('unitSelect').value;
      updateDisplays();
      log('Units changed to ' + unit);
    }

    function updateRangeDisplay(id, value){
      document.getElementById(id + 'Value').textContent = value;
    }

    function updateUserName(){
      userName = document.getElementById('userName').value.trim();
      log('Name updated to: ' + (userName || 'None'));
    }

    function updateAge(){
      userAge = Number(document.getElementById('userAge').value) || 30;
      hrMax = 220 - userAge;
      log(`Age: ${userAge}, Max HR: ${hrMax}`);
    }

    function getHRZone(hr, hrMax) {
      const pct = hr / hrMax;
      if (pct < 0.6) return { zone: 1, name: "Very Easy", color: "#3b82f6" };
      if (pct < 0.7) return { zone: 2, name: "Easy", color: "#10b981" };
      if (pct < 0.8) return { zone: 3, name: "Moderate", color: "#fbbf24" };
      if (pct < 0.9) return { zone: 4, name: "Hard", color: "#f97316" };
      return { zone: 5, name: "Very Hard", color: "#dc2626" };
    }

    function checkHRSafety(hr, hrMax) {
      const pct = hr / hrMax;
      const now = Date.now();
      
      // Danger: > 95% HRmax (immediate warning, but only once per 30s)
      if (pct > 0.95) {
        const timeSinceLastWarning = (now - lastHrWarningTime.danger) / 1000;
        if (timeSinceLastWarning >= 30) {
          lastHrWarningTime.danger = now;
          return {
            level: 'danger',
            message: "Your heart rate is extremely high. Stop running now and walk slowly. If you feel unwell, seek medical help."
          };
        }
        return null;
      }
      
      // Hard warning: > 90% HRmax (after 30s sustained, then repeat every 30s)
      if (pct > 0.9) {
        if (!highHrStartTime) highHrStartTime = now;
        const duration = (now - highHrStartTime) / 1000;
        const timeSinceLastWarning = (now - lastHrWarningTime.warning) / 1000;
        
        if (duration > 30 && timeSinceLastWarning >= 30) {
          lastHrWarningTime.warning = now;
          return {
            level: 'warning',
            message: "Your heart rate is very high. Please slow down or walk until your heart rate drops back to a comfortable level."
          };
        }
        return null;
      }
      
      // Caution: > 85% HRmax (after 60s sustained, then repeat every 30s)
      if (pct > 0.85) {
        if (!highHrStartTime) highHrStartTime = now;
        const duration = (now - highHrStartTime) / 1000;
        const timeSinceLastWarning = (now - lastHrWarningTime.caution) / 1000;
        
        if (duration > 60 && timeSinceLastWarning >= 30) {
          lastHrWarningTime.caution = now;
          return {
            level: 'caution',
            message: "You're working pretty hard now. If this isn't intentional, try slowing your pace."
          };
        }
        return null;
      } else {
        // Reset timer when HR drops below 85%
        highHrStartTime = null;
      }
      
      return null;
    }

    // ============================================
    // MODAL CONTROLS
    // ============================================
    function openSettings(){
      document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettings(){
      document.getElementById('settingsModal').classList.remove('show');
    }

    // ============================================
    // RUN CONTROLS
    // ============================================
    function toggleRun(){
      // Always stop first to prevent multiple intervals
      stopRun();
      
      running = !running;
      const btn = document.getElementById('startBtn');
      if (running) {
        btn.textContent = '‚è∏Ô∏è Pause';
        btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        startRun();
        log('Run started');
      } else {
        btn.textContent = '‚ñ∂Ô∏è Start';
        btn.style.background = 'linear-gradient(135deg, var(--btn-primary-start) 0%, var(--btn-primary-end) 100%)';
        log('Run paused');
      }
    }

    function startRun(){
      runInterval = setInterval(() => {
        time++;
        dist += (1 / pace) / 60;
        hr = Math.round(Math.max(60, Math.min(200, hr + (Math.random() - 0.5) * 3)));
        
        // Check for kilometer/mile milestones
        const currentKm = Math.floor(dist);
        if (currentKm > lastKmMilestone && currentKm > 0) {
          lastKmMilestone = currentKm;
          const distStr = (unit === 'miles' ? kmToMiles(dist) : dist).toFixed(2);
          const msg = chooseTemplate('milestone', {dist: distStr});
          speakText(msg);
          log('üéØ Milestone: ' + currentKm + ' km');
        }
        
        updateDisplays();
      }, 1000);
    }

    function stopRun(){
      if (runInterval) {
        clearInterval(runInterval);
        runInterval = null;
      }
    }

    function randomizeTelemetry(){
      pace = Math.floor(Math.random() * 300) + 240; // 4:00-9:00
      hr = Math.floor(Math.random() * 80) + 120; // 120-200
      dist = Math.random() * 10; // 0-10km
      updateDisplays();
      log('Telemetry randomized');
    }

    function testVoice(){
      const msg = chooseTemplate('status', {
        pace: secToMinSec(pace), 
        hr, 
        dist: (unit === 'miles' ? kmToMiles(dist) : dist).toFixed(2)
      });
      speakText(msg);
    }

    function speakManual(){
      const text = document.getElementById('manualText').value || "Keep going!";
      speakText(text);
    }

    function toggleAuto(){
      auto = !auto;
      document.getElementById('toggleAutoBtn').textContent = auto ? 'Disable' : 'Enable';
      log('Auto prompts ' + (auto ? 'enabled' : 'disabled'));
    }

    // ============================================
    // AUTO PROMPTS
    // ============================================
    setInterval(()=>{
      if (!auto || !running) return;
      const targetPace = parseMinSec(document.getElementById('targetPace').value || '5:00');
      const paceDelta = pace - targetPace;
      const hrTarget = Number(document.getElementById('targetHR').value || 150);

      // HR too high - tell them to slow down and breathe
      if (hr > hrTarget + 10){
        const msg = chooseTemplate('slowDown', {pace: secToMinSec(pace), hr, dist: dist.toFixed(2)});
        speakText(msg);
        log('‚ö†Ô∏è HR high - instructing to slow down');
      } 
      // Pace too slow - tell them to pick it up (will use motivational style automatically)
      else if (paceDelta > 15) {
        const msg = chooseTemplate('push', {pace: secToMinSec(pace), hr, dist: dist.toFixed(2)});
        speakText(msg);
        log('‚ö° Pace slow - instructing to speed up');
      }
      // Pace too fast - maintain control
      else if (paceDelta < -15) {
        const msg = chooseTemplate('status', {pace: secToMinSec(pace), hr, dist: dist.toFixed(2)});
        speakText(msg);
        log('üìä Status update');
      }
    }, 30000); // Check every 30 seconds to avoid spam

    // ============================================
    // INITIALIZATION
    // ============================================
    updateAge();
    updateDisplays();
    loadVoices();
    log('Dashboard ready');
  </script>
</body>
</html>
